@model Astro.DAL.Models.Topic

@using Microsoft.AspNetCore.Identity
@using Astro.DAL.Models

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager

@{
    ViewData["Title"] = Model.Title.Substring(0, 10) + "...";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>@Model.Title</h1>

<h5>@Model.Date @Model.User.Email</h5>

@if (SignInManager.IsSignedIn(User))
{
    <h5><a asp-controller="Forum" asp-action="ChangeRate" asp-route-id="@Model.Id" asp-route-up="false"><img src="~/Images/red_down.jpg" width="25px" height="25px" /></a> @Model.Rate <a asp-controller="Forum" asp-action="ChangeRate" asp-route-id="@Model.Id" asp-route-up="true"><img src="~/Images/green_up.png" width="25px" height="25px" /></a></h5>
}

<hr />

@foreach (var item in Model.Comments)
{
    <table class="table table-striped table-bordered">
        <tr>
            <td width="20%">
                @item.User.Email
            </td>
            <td>
                <div id=@("CommentContent"+item.Id)>
                    @item.Content
                </div>

                <div id=@("EditCommentForm"+item.Id) style="display:none">
                    <form asp-controller="Forum" asp-action="EditComment">
                        <input type="hidden" name="id" value="@item.Id" />
                        <input type="hidden" name="topicId" value="@Model.Id" />
                        <input type="text" name="comment" value="@item.Content" class="form-control" />
                        <input type="submit" value="Zapisz" class="btn btn-primary" />
                    </form>
                </div>

            </td>
            <td width="20%">
                @if (SignInManager.IsSignedIn(User))
                {
                    <button class="btn btn-primary" onclick="EditComment(@item.Id)">Edytuj</button>
                }
                @if (User.IsInRole("Administrator"))
                {
                    if (Model.Comments.IndexOf(item) != 0)
                    {
                        <a asp-controller="Forum" asp-action="DeleteComment" asp-route-id="@item.Id" asp-route-topicId="@Model.Id" class="btn btn-danger">Usuń</a>
                    }
                }
            </td>
        </tr>
    </table>
    <hr />
}

@if (SignInManager.IsSignedIn(User))
{
    <br />
    <form asp-controller="Forum" asp-action="AddComment">
        <input type="hidden" name="topicId" value="@Model.Id" />
        <label class="control-label">Treść</label>
        <textarea name="comment" class="form-control"></textarea>
        <input type="submit" value="Wyślij" class="btn btn-primary" />
    </form>
}

<script>

    function EditComment(id) {
        content = document.getElementById("CommentContent" + id);
        form = document.getElementById("EditCommentForm" + id);
        if (form.style.display == "none") {
            form.style.display = "block";
            content.style.display = "none";
        }
        else {
            form.style.display = "none";
            content.style.display = "block";
        }
    }

</script>